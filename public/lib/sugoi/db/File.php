<?php
/**
 * Generated by Haxe 4.0.0-rc.1+1fdd3d5
 */

namespace sugoi\db;

use \php\_Boot\HxAnon;
use \php\Boot;
use \haxe\io\StringInput;
use \sys\db\Object_hx;
use \sys\db\Manager;
use \php\_Boot\HxString;
use \haxe\io\Bytes;

/**
 * Store files in DB
 */
class File extends Object_hx {
	/**
	 * @var \Array_hx
	 */
	static public $CACHE;
	/**
	 * @var Manager
	 */
	static public $manager;

	/**
	 * @var \Date
	 */
	public $cdate;
	/**
	 * @var Bytes
	 */
	public $data;
	/**
	 * @var int
	 */
	public $id;
	/**
	 * @var string
	 */
	public $name;

	/**
	 * Creates a File record
	 * from string data (typically sent from a form) and a file name
	 * 
	 * @param string $stringData
	 * @param string $fileName
	 * 
	 * @return File
	 */
	static public function create ($stringData, $fileName = "") {
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:46: lines 46-51
		if ($fileName === null) {
			$fileName = "";
		}
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:48: characters 3-61
		$bytes = (new StringInput($stringData))->readAll();
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:49: characters 3-42
		return File::createFromBytes($bytes, $fileName);
	}

	/**
	 * @param Bytes $b
	 * @param string $fileName
	 * 
	 * @return File
	 */
	static public function createFromBytes ($b, $fileName = "") {
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:54: lines 54-69
		if ($fileName === null) {
			$fileName = "";
		}
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:64: characters 3-24
		$hexa = bin2hex($b->b->s);
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:65: characters 3-90
		Manager::$cnx->request("INSERT INTO File (name,data) VALUES ('" . ($fileName??'null') . "', 0x" . ($hexa??'null') . ")");
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:66: characters 3-46
		return File::$manager->unsafeObjects("SELECT * FROM File WHERE " . (Manager::nullCompare("name", Manager::quoteAny($fileName), true)??'null'), true)->first();
	}

	/**
	 * Get the file name related to this File record.
	 * Usually files should be generated in /file/
	 * 
	 * @param int $id
	 * 
	 * @return string
	 */
	static public function makeSign ($id) {
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:29: lines 29-30
		if ($id === null) {
			#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:30: characters 4-13
			return "";
		}
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:31: characters 3-21
		$s = (File::$CACHE->arr[$id] ?? null);
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:32: characters 3-27
		if ($s !== null) {
			#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:32: characters 19-27
			return $s;
		}
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:33: characters 3-64
		$s = ($id??'null') . "_" . (md5(($id??'null') . (\App::$config->get("key")??'null'))??'null');
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:34: characters 3-16
		File::$CACHE[$id] = $s;
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:35: characters 3-11
		return $s;
	}

	/**
	 * @return void
	 */
	public function __construct () {
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:20: characters 3-10
		parent::__construct();
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:21: characters 3-21
		$this->cdate = \Date::now();
	}

	/**
	 * @return Manager
	 */
	public function __getManager () {
		#/home/bubar/projects/spod/src/sys/db/RecordMacros.hx:1432: characters 19-40
		return File::$manager;
	}

	/**
	 * @return string
	 */
	public function getExtension () {
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:72: characters 3-45
		if (($this->name === null) || ($this->name === "")) {
			#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:72: characters 33-45
			return "jpg";
		}
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:74: characters 3-28
		return (HxString::split($this->name, ".")->arr[1] ?? null);
	}

	/**
	 * @return string
	 */
	public function toString () {
		#/home/bubar/projects/sugoi/src/sugoi/db/File.hx:39: characters 3-31
		return "#" . ($this->id??'null') . " " . ($this->name??'null');
	}

	public function __toString() {
		return $this->toString();
	}

	/**
	 * @internal
	 * @access private
	 */
	static public function __hx__init ()
	{
		static $called = false;
		if ($called) return;
		$called = true;


		self::$CACHE = new \Array_hx();
		self::$manager = new Manager(Boot::getClass(File::class));
	}
}

Boot::registerClass(File::class, 'sugoi.db.File');
Boot::registerMeta(File::class, new HxAnon(["obj" => new HxAnon(["rtti" => \Array_hx::wrap(["oy7:hfieldsby4:nameoR1R1y1:tjy17:sys.db.RecordType:13:0y6:isNullfgy2:idoR1R5R2jR3:0:0R4fgy4:dataoR1R6R2jR3:18:0R4fgy5:cdateoR1R7R2jR3:11:0R4tghR1y4:Filey9:relationsahy7:indexesahy6:fieldsar4r2r8r6hy3:keyaR5hg"])])]));
File::__hx__init();
