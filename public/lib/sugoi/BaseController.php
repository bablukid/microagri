<?php
/**
 * Generated by Haxe 4.0.0-rc.1+1fdd3d5
 */

namespace sugoi;

use \php\Boot;
use \haxe\CallStack;
use \sys\io\Process;
use \sugoi\db\File;
use \php\Web as PhpWeb;
use \php\_Boot\HxString;
use \sys\io\File as IoFile;
use \sys\FileSystem;
use \php\_Boot\HxException;

class BaseController {
	/**
	 * @var \App
	 */
	public $app;
	/**
	 * @var mixed
	 */
	public $view;

	/**
	 * @return void
	 */
	public function __construct () {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:13: characters 3-20
		$this->app = \App::$current;
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:14: characters 3-18
		$this->view = $this->app->view;
	}

	/**
	 * @param string $url
	 * @param string $text
	 * 
	 * @return ControllerAction
	 */
	public function Error ($url, $text = null) {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:36: characters 3-32
		return ControllerAction::ErrorAction($url, $text);
	}

	/**
	 * @param string $url
	 * @param string $text
	 * 
	 * @return ControllerAction
	 */
	public function Ok ($url, $text = null) {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:40: characters 3-29
		return ControllerAction::OkAction($url, $text);
	}

	/**
	 * @param string $url
	 * 
	 * @return ControllerAction
	 */
	public function Redirect ($url) {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:32: characters 3-29
		return ControllerAction::RedirectAction($url);
	}

	/**
	 * @return bool
	 */
	public function checkToken () {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:22: characters 3-84
		$token = md5(($this->app->session->sid??'null') . (mb_substr(\App::$config->KEY, 0, 6)??'null'));
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:23: characters 3-21
		$this->view->token = $token;
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:24: characters 3-42
		return ($this->app->params->data["token"] ?? null) === $token;
	}

	/**
	 * User uploaded images are stored in the db.File table.
	 * When there is an attempt to display an image like /file/***.jpg
	 * the .htaccess in /file/ redirects to this handler to generate the file from the DB
	 * @param	fname
	 * 
	 * @param string $fname
	 * 
	 * @return void
	 */
	public function doFile ($fname) {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:52: characters 4-34
		$fid = \Std::parseInt($fname);
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:53: characters 3-40
		$f = File::$manager->unsafeGet($fid, false);
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:54: characters 3-52
		$ext = mb_substr($fname, HxString::lastIndexOf($fname, "."), null);
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:55: lines 55-58
		if ($f === null) {
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:56: characters 4-82
			echo(\Std::string("404 - File not found '" . (htmlspecialchars($fname, (null ? ENT_QUOTES | ENT_HTML401 : ENT_NOQUOTES))??'null') . "' id #" . ($fid??'null')));
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:57: characters 4-10
			return;
		}
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:59: lines 59-62
		if ($fname !== ((File::makeSign($fid)??'null') . ($ext??'null'))) {
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:60: characters 4-95
			echo(\Std::string("404 - File signature do not match '" . ($fname??'null') . "' != '" . (File::makeSign($fid)??'null') . ($ext??'null') . "'"));
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:61: characters 4-10
			return;
		}
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:63: characters 3-12
		$path = null;
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:64: characters 3-10
		$ch = null;
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:65: lines 65-72
		try {
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:66: characters 4-56
			$path = (dirname($_SERVER["SCRIPT_FILENAME"])??'null') . "/" . "/file/" . (File::makeSign($f->id)??'null') . ($ext??'null');
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:67: characters 4-37
			$ch = IoFile::write($path, true);
		} catch (\Throwable $__hx__caught_e) {
			CallStack::saveExceptionTrace($__hx__caught_e);
			$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
			$e = $__hx__real_e;
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:69: characters 4-18
			usleep((int)(100000.));
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:70: characters 4-41
			PhpWeb::redirect((PhpWeb::getURI()??'null') . "?retry=1");
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:71: characters 4-10
			return;
		}
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:73: characters 3-19
		$ch->write($f->data);
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:74: characters 3-13
		$ch->close();
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:76: lines 76-89
		try {
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:81: characters 4-60
			$s = FileSystem::stat((dirname($_SERVER["SCRIPT_FILENAME"])??'null') . "/" . "index.php");
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:83: characters 4-35
			$mtime = $s->mtime->toString();
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:86: characters 4-63
			$p = new Process("touch", \Array_hx::wrap([
				"-m",
				"-d",
				$mtime,
				$path,
			]));
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:87: characters 4-16
			$p->exitCode();
		} catch (\Throwable $__hx__caught_e) {
			CallStack::saveExceptionTrace($__hx__caught_e);
			$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
			$e1 = $__hx__real_e;
					}
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:91: characters 3-41
		PhpWeb::redirect((PhpWeb::getURI()??'null') . "?reload=1");
	}

	/**
	 * @param string $v
	 * 
	 * @return string
	 */
	public function getParam ($v) {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:18: characters 10-27
		return ($this->app->params->data[$v] ?? null);
	}

	/**
	 * @return bool
	 */
	public function isAdmin () {
		#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:28: characters 10-48
		if ($this->app->user !== null) {
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:28: characters 30-48
			return $this->app->user->isAdmin();
		} else {
			#/home/bubar/projects/sugoi/src/sugoi/BaseController.hx:28: characters 10-48
			return false;
		}
	}
}

Boot::registerClass(BaseController::class, 'sugoi.BaseController');
