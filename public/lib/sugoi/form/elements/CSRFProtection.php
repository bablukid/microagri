<?php
/**
 * Generated by Haxe 4.0.0-rc.1+1fdd3d5
 */

namespace sugoi\form\elements;

use \php\Boot;
use \php\Web;
use \php\_Boot\HxException;

/**
 * creates a hidden token in forms to avoid CSRF
 */
class CSRFProtection extends StringInput {
	/**
	 * @return void
	 */
	public function __construct () {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:19: characters 3-88
		$this->value = md5((\App::$current->session->sid??'null') . (mb_substr(\App::$config->KEY, 0, 5)??'null'));
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:20: characters 3-33
		parent::__construct("token", "", $this->value, true);
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:21: characters 3-23
		$this->inputType = InputType::ITHidden();
	}

	/**
	 * @return string
	 */
	public function getFullRow () {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:36: characters 3-18
		return $this->render();
	}

	/**
	 * @return bool
	 */
	public function isValid () {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:25: characters 3-27
		if ($this->value === null) {
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:25: characters 22-27
			throw new HxException("empty token");
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:26: characters 3-74
		$valid = (Web::getParams()->data[($this->parentForm->name??'null') . "_" . ($this->name??'null')] ?? null) === $this->value;
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:28: lines 28-30
		if (!$valid) {
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:29: characters 4-27
			$this->errors->add("Bad token");
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:31: characters 3-15
		return $valid;
	}

	/**
	 * @return string
	 */
	public function render () {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/CSRFProtection.hx:41: characters 3-166
		return "<input type=\"hidden\" value=\"" . ($this->value??'null') . "\" " . ($this->attributes??'null') . " name=\"" . ($this->parentForm->name??'null') . "_" . ($this->name??'null') . "\" id=\"" . ($this->parentForm->name??'null') . "_" . ($this->name??'null') . "\" />";
	}
}

Boot::registerClass(CSRFProtection::class, 'sugoi.form.elements.CSRFProtection');
