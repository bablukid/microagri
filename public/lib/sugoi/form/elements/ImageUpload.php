<?php
/**
 * Generated by Haxe 4.0.0-rc.1+1fdd3d5
 */

namespace sugoi\form\elements;

use \php\Boot;
use \sugoi\tools\Utils;
use \sugoi\form\FormElement;
use \haxe\io\StringInput as IoStringInput;
use \haxe\io\Bytes;

/**
 * Manage an <input type="file" /> element for uploading images.
 */
class ImageUpload extends FormElement {
	/**
	 * @var string
	 */
	public $fileName;
	/**
	 * @var int
	 */
	public $maxSize;
	/**
	 * @var int
	 */
	public $previewMaxSize;
	/**
	 * @var string
	 */
	public $text;
	/**
	 * @var string
	 */
	public $url;

	/**
	 * @param	name
	 * @param	label
	 * @param	url			file URL for previewing the image
	 * @param	required
	 * 
	 * @param string $name
	 * @param string $label
	 * @param string $url
	 * @param bool $required
	 * 
	 * @return void
	 */
	public function __construct ($name, $label, $url = null, $required = false) {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:23: lines 23-34
		if ($required === null) {
			$required = false;
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:24: characters 3-10
		parent::__construct();
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:26: characters 3-29
		$this->name = "upload_" . ($name??'null');
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:27: characters 3-21
		$this->label = $label;
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:29: characters 3-17
		$this->url = $url;
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:30: characters 3-27
		$this->required = $required;
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:31: characters 3-18
		$this->fileName = null;
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:32: characters 3-14
		$this->maxSize = 6;
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:33: characters 3-23
		$this->previewMaxSize = 200;
	}

	/**
	 * @param string $s
	 * 
	 * @return Bytes
	 */
	public function getTypedValue ($s) {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:38: characters 3-71
		$request = Utils::getMultipart(1048576 * $this->maxSize);
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:40: characters 3-69
		$strData = ($request->data[($this->parentForm->name??'null') . "_" . ($this->name??'null') . "_data"] ?? null);
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:41: lines 41-44
		if (($strData !== null) && ($strData !== "")) {
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:42: characters 4-75
			$this->fileName = ($request->data[($this->parentForm->name??'null') . "_" . ($this->name??'null') . "_data_filename"] ?? null);
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:43: characters 4-53
			return (new IoStringInput($strData))->readAll();
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:46: characters 3-14
		return null;
	}

	/**
	 * @return bool
	 */
	public function hasDeleteAction () {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:50: characters 3-39
		$n = ($this->parentForm->name??'null') . "_" . ($this->name??'null');
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:51: characters 3-56
		return (\App::$current->params->data[($n??'null') . "_delete"] ?? null) === "1";
	}

	/**
	 * Renders an input + image preview + delete btn
	 * 
	 * @return string
	 */
	public function render () {
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:59: characters 3-39
		$n = ($this->parentForm->name??'null') . "_" . ($this->name??'null');
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:60: characters 3-29
		$str = new \StringBuf();
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:61: characters 3-67
		$str->add("<div class=\"imageUpload\" style=\"position: relative;\">");
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:62: characters 3-174
		if ($this->url !== null) {
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:62: characters 18-174
			$str->add("<img id=\"" . ($n??'null') . (("_preview\" src=\"" . ($this->url??'null') . "\" class=\"img-thumbnail\" style=\"max-width:")??'null') . ($this->previewMaxSize??'null') . "px;max-height:" . ($this->previewMaxSize??'null') . "px;float:right;\">");
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:63: characters 3-115
		$str->add("<input class=\"btn btn-default\" type=\"file\" name=\"" . ($n??'null') . "_data\" id=\"" . ($n??'null') . "\" " . ($this->attributes??'null') . " />");
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:64: characters 3-44
		if ($this->text !== null) {
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:64: characters 21-44
			$str->add("<p>" . ($this->text??'null') . "</p>");
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:65: lines 65-69
		if (!$this->required && ($this->url !== null)) {
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:66: characters 4-285
			$str->add("<a style=\"position:absolute;right:3px;top:3px;\" href=\"#\" class=\"btn btn-default btn-xs\" onclick=\"document.getElementById('" . ($n??'null') . "_delete').value = '1';document.getElementById('" . ($n??'null') . "_preview').style.display='none';this.style.display='none';return false;\">");
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:67: characters 4-76
			$str->add("<span class=\"glyphicon glyphicon-remove\" alt=\"Remove\"></span>");
			#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:68: characters 4-19
			$str->add("</a>");
		}
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:70: characters 3-92
		$str->add("<input type=\"hidden\" name=\"" . ($n??'null') . "_delete\" id=\"" . ($n??'null') . "_delete\" value=\"0\"/>");
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:71: characters 3-20
		$str->add("</div>");
		#/home/bubar/projects/sugoi/src/sugoi/form/elements/ImageUpload.hx:73: characters 3-24
		return $str->b;
	}
}

Boot::registerClass(ImageUpload::class, 'sugoi.form.elements.ImageUpload');
