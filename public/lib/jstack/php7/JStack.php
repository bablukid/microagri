<?php
/**
 * Generated by Haxe 4.0.0-rc.1+1fdd3d5
 */

namespace jstack\php7;

use \php\Boot;
use \haxe\StackItem;
use \haxe\CallStack;
use \haxe\ds\StringMap;
use \php\_Boot\HxException;

/**
 * Handles source map
 */
class JStack {
	/**
	 * @var bool
	 */
	static public $mapPositionDefined = false;
	/**
	 * @var StringMap
	 */
	static public $sourceMaps;
	/**
	 * @var \Closure
	 * Overwrite this method to handle uncaught exceptions manually.
	 * Any returned value will be written to stderr.
	 * @param e - Uncaught exception.
	 */
	static public $uncaughtExceptionHandler;

	/**
	 * Actual handler passed to `set_exception_handler`
	 * @param e -
	 * 
	 * @param \Throwable $e
	 * 
	 * @return void
	 */
	static public function _uncaughtExceptionHandler ($e) {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:63: characters 9-49
		$error = (JStack::$uncaughtExceptionHandler)($e);
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:64: characters 9-40
		\Sys::stderr()->writeString($error);
	}

	/**
	 * @param \Throwable $e
	 * 
	 * @return mixed
	 */
	static public function getNativeStack ($e) {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:112: characters 9-34
		$stack = $e->getTrace();
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:114: characters 24-55
		$this1 = [];
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:114: characters 9-56
		$thrownAt = $this1;
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:115: characters 9-34
		$thrownAt["function"] = "";
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:116: characters 9-39
		$thrownAt["line"] = $e->getLine();
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:117: characters 9-39
		$thrownAt["file"] = $e->getFile();
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:118: characters 9-31
		$thrownAt["class"] = "";
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:119: characters 28-45
		$this2 = [];
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:119: characters 9-45
		$thrownAt["args"] = $this2;

		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:120: characters 9-39
		array_unshift($stack, $thrownAt);
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:122: characters 9-21
		return $stack;
	}

	/**
	 * Handles source map parsers for each file.
	 * @param file - A name of a generated php file.
	 * 
	 * @param string $file
	 * 
	 * @return \SourceMap
	 */
	static public function getSourceMap ($file) {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:101: characters 9-40
		$map = (JStack::$sourceMaps->data[$file] ?? null);
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:102: lines 102-107
		if (($map === null) && !array_key_exists($file, JStack::$sourceMaps->data)) {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:103: lines 103-105
			try {
				#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:104: characters 17-68
				$map = new \SourceMap(file_get_contents("" . ($file??'null') . ".map"));
			} catch (\Throwable $__hx__caught_e) {
				CallStack::saveExceptionTrace($__hx__caught_e);
				$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
				$e = $__hx__real_e;
							}
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:106: characters 13-38
			JStack::$sourceMaps->data[$file] = $map;
		}
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:108: characters 9-19
		return $map;
	}

	/**
	 * Initialization
	 * 
	 * @return void
	 */
	static public function init () {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:46: characters 9-70
		$phpClassName = Boot::getPhpName(\Type::getClassName(Boot::getClass(CallStack::class)));
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:47: characters 9-74
		JStack::$mapPositionDefined = property_exists($phpClassName, "mapPosition");
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:48: lines 48-50
		if (JStack::$mapPositionDefined) {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:49: characters 35-47
			$tmp = $phpClassName;
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:49: characters 13-76
			$tmp::${"mapPosition"} = Boot::getStaticClosure(JStack::class, 'mapPosition');
		}
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:53: characters 9-76
		$userDefined = set_exception_handler(Boot::getStaticClosure(JStack::class, '_uncaughtExceptionHandler'));
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:55: characters 9-68
		if ($userDefined !== null) {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:55: characters 34-68
			set_exception_handler($userDefined);
		}
	}

	/**
	 * Map position in generated php file to original position in source hx file.
	 * @param file - Generated php file name.
	 * @param line - Line in generated php file name.
	 * @return SourcePos
	 * 
	 * @param string $file
	 * @param int $line
	 * 
	 * @return object
	 */
	static public function mapPosition ($file, $line) {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:92: characters 19-37
		$map = (JStack::$sourceMaps->data[$file] ?? null);
		if (($map === null) && !array_key_exists($file, JStack::$sourceMaps->data)) {
			try {
				$map = new \SourceMap(file_get_contents("" . ($file??'null') . ".map"));
			} catch (\Throwable $__hx__caught_e) {
				CallStack::saveExceptionTrace($__hx__caught_e);
				$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
				$e = $__hx__real_e;
							}
			JStack::$sourceMaps->data[$file] = $map;
		}
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:92: characters 9-38
		$map1 = $map;
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:93: characters 16-68
		if ($map1 === null) {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:93: characters 31-35
			return null;
		} else {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:93: characters 38-67
			return $map1->originalPositionFor($line);
		}
	}

	/**
	 * Replaces file name and line number in stack items.
	 * @param item -
	 * 
	 * @param StackItem $item
	 * 
	 * @return StackItem
	 */
	static public function mapStackItem ($item) {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:72: lines 72-82
		if ($item->index === 2) {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:73: characters 40-44
			$line = $item->params[2];
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:73: characters 34-38
			$file = $item->params[1];
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:73: characters 26-32
			$symbol = $item->params[0];
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:74: characters 27-50
			$map = (JStack::$sourceMaps->data[$file] ?? null);
			if (($map === null) && !array_key_exists($file, JStack::$sourceMaps->data)) {
				try {
					$map = new \SourceMap(file_get_contents("" . ($file??'null') . ".map"));
				} catch (\Throwable $__hx__caught_e) {
					CallStack::saveExceptionTrace($__hx__caught_e);
					$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
					$e = $__hx__real_e;
									}
				JStack::$sourceMaps->data[$file] = $map;
			}
			$map1 = $map;
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:74: characters 17-51
			$pos = ($map1 === null ? null : $map1->originalPositionFor($line));
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:75: lines 75-79
			if ($pos === null) {
				#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:76: characters 21-32
				return $item;
			} else {
				#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:78: characters 21-73
				return StackItem::FilePos($symbol, $pos->source, $pos->originalLine);
			}
		} else {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:81: characters 17-28
			return $item;
		}
	}

	/**
	 * Invokes initialization.
	 * 
	 * @param \Closure $callback
	 * 
	 * @return void
	 */
	static public function onReady ($callback) {
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:22: characters 9-15
		JStack::init();
		#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:23: characters 9-19
		$callback();
	}

	/**
	 * @internal
	 * @access private
	 */
	static public function __hx__init ()
	{
		static $called = false;
		if ($called) return;
		$called = true;


		self::$uncaughtExceptionHandler = function ($e)  use (&$value) {
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:33: characters 9-60
			$stack = CallStack::makeStack(JStack::getNativeStack($e));
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:34: lines 34-36
			if (!JStack::$mapPositionDefined) {
				#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:35: characters 21-44
				$f = Boot::getStaticClosure(JStack::class, 'mapStackItem');
				$result = [];
				$collection = $stack->arr;
				foreach ($collection as $key => $value) {
					$result[] = $f($value);
				}

				$stack = \Array_hx::wrap($result);
			}
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:37: characters 9-71
			$error = ($e->getMessage()??'null') . (CallStack::toString($stack)??'null') . "\x0A";
			#/home/bubar/haxe/haxe_libraries/jstack/2.3.11/haxelib/src/jstack/php7/JStack.hx:38: characters 9-21
			return $error;
		};
		self::$sourceMaps = new StringMap();
	}
}

Boot::registerClass(JStack::class, 'jstack.php7.JStack');
JStack::__hx__init();
